@using Online_book_shop.Models;
@using Online_book_shop.Models.ViewModel;
@using Online_book_shop.Handlers.Helper;
@using Online_book_shop.Handlers.Business;
@{
    //Author author = ViewBag.Author;
    List<BookVMTile> books = ViewBag.Books != null ? ViewBag.Books : new List<BookVMTile>();
    int NumberOfBooks = ViewBag.TotalNumberOfBooks != null ? ViewBag.TotalNumberOfBooks : 0;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Muses Books </title>
</head>
<body>
    <div class="container">
       
        <div class="authors-work">
            @*<h2>Book(s) by @author.Name</h2>*@
            <div class="elementfound">@NumberOfBooks Books found</div>
            @if (NumberOfBooks < 13)
            {
                <div class="pagination">
                    <a class="prev">&lt;&lt; Previous</a>
                    <div class="currentpage">1</div>
                    <a class="Next">Next &gt;&gt; </a>
                </div>
            }
            else
            {
                if (Request.QueryString["page"] != null)
                {
                    if (Convert.ToInt32(Request.QueryString["page"]) > 0 && Convert.ToInt32(Request.QueryString["page"]) * 12 < NumberOfBooks)
                    {
                        int page = Convert.ToInt32(Request.QueryString["page"]);
                        <div class="pagination">
                            <a href="/bookprofile/collection?page=@(page-1)" class="prev">&lt;&lt; Previous</a>
                            <div class="currentpage">1</div>
                            <a href="/bookprofile/collection?page=@(page+1)" class="Next">Next &gt;&gt; </a>
                        </div>
                    }
                }

            }

            <div class="bookcat-col active">
                @if (books != null)
                {
                    <div class="authorwork book-overview">
                        @foreach (BookVMTile b in books)
                        {
                            BookProperties bookProperty = b.Property.Where(p => p.NumberOfCopies > 0).OrderBy(p => p.Price).FirstOrDefault();
                            BookPromotionVM promo = BusinessHandlerPromotion.GetPromotionForBook(b.Id, bookProperty != null ? bookProperty.Id : 0, bookProperty != null ? bookProperty.Price : 0);
                            <div class="item">
                                <div class="item-inner">
                                    @if (promo != null)
                                    {
                                        if (promo.PromotionMethods == (int)PromotionMethods.DeductFromFinalAmount)
                                        {
                                            <div class="discount-pers">Offer<br />Off</div>

                                        }
                                        else if (promo.PromotionMethods == (int)PromotionMethods.FixedAmount)
                                        {
                                            <div class="discount-pers">@promo.DiscountValue<br />Off</div>

                                        }
                                        else if (promo.PromotionMethods == (int)PromotionMethods.Percentage)
                                        {
                                            <div class="discount-pers">@promo.DiscountValue%<br />Off</div>

                                        }
                                    }
                                    <div class="viewmore-discprice">
                                        <a href="/bookprofile/@b.Id" class="viewmore"></a>
                                        @if (promo != null && promo.DiscountValue > 0)
                                        {
                                            <div class="discounted-price">-Rs.@promo.DiscountAmount/=</div>
                                        }
                                    </div>
                                    <div class="book-image">
                                        @if (b.FrontCover != null && HTMLHelper.isImageExist("Content/UploadFiles/Images/BookFrontCover/" + b.FrontCover.FileName))
                                        {
                                            <img src="@Url.Action("Thumbnail", "Utility", new {FileName="~/Content/UploadFiles/Images/BookFrontCover/"+b.FrontCover.FileName})"
                                                 class="img-fluid"
                                                 title="@b.BookName"
                                                 alt="muses @b.BookName" />
                                            @*<img src="~/Content/UploadFiles/Images/BookFrontCover/@b.FrontCover.FileName?w=160&h=100" alt="@b.BookName" />*@
                                        }
                                        else
                                        {
                                            <img src="~/Content/images/no-image-book.jpg" alt="@b.BookName" />
                                        }

                                    </div>
                                    <div class="book-name-author ">
                                        <div class="name"><span class="sinhala">@b.LocalBookName</span> - <span class="english">@b.BookName</span></div>
                                    </div>
                                    <div class="book-name-author">
                                        <div class="author"><span class="sinhala">@b.LocalAuthorName</span> - <span class="english">@b.AuthorName</span></div>
                                    </div>

                                    <div class="category">
                                        @foreach (Category c in b.Categories.Take(2))
                                        {
                                            <span class="cat-name">@c.CategoryName</span>
                                        }
                                    </div>
                                    <div class="rating">
                                        <div class="stars" data-rating="@b.Rating"></div>
                                    </div>
                                    @{
                                        if (bookProperty != null)
                                        {
                                            if (promo != null)
                                            {
                                                if (promo.DiscountAmount > 0)
                                                {
                                                    <div class="price hasdiscount">Rs.@promo.BookPrice/=</div>
                                                    <div class="discount-price">Rs.@promo.BookPriceAfterDiscount./=</div>
                                                }
                                                else
                                                {
                                                    <div class="discount-price">Rs.@bookProperty.Price/=</div>
                                                }
                                            }
                                            <div class="addto-cart btn-active add-to-cart" data-book_id="@b.Id" data-book_prop_id="@bookProperty.Id" data-number_of_items="1">
                                                Add to Cart
                                                <div class="icon"></div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="price">Out of stock</div>
                                            <div class="addto-cart btn-active">
                                                Add to Cart
                                                <div class="icon"></div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

            </div>
            @if (NumberOfBooks < 13)
            {
                <div class="pagination">
                    <a class="prev">&lt;&lt; Previous</a>
                    <div class="currentpage">1</div>
                    <a class="Next">Next &gt;&gt; </a>
                </div>
            }
            else
            {
                if (Request.QueryString["page"] != null)
                {
                    if (Convert.ToInt32(Request.QueryString["page"]) > 0 && Convert.ToInt32(Request.QueryString["page"]) * 12 < NumberOfBooks)
                    {
                        int page = Convert.ToInt32(Request.QueryString["page"]);
                        <div class="pagination">
                            <a href="/bookprofile/collection?page=@(page-1)" class="prev">&lt;&lt; Previous</a>
                            <div class="currentpage">1</div>
                            <a href="/bookprofile/collection?page=@(page+1)" class="Next">Next &gt;&gt; </a>
                        </div>
                    }
                }

            }
        </div>
    </div>
</body>
</html>

